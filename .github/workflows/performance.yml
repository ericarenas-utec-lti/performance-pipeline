name: Automated Performance Testing
on: [push, pull_request]

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup directories
      run: |
        mkdir -p test-plans config results
        chmod +x config/check-thresholds.sh
        
    - name: Run JMeter tests
      run: |
        docker run --rm \
          -v $PWD/test-plans:/test-plans \
          -v $PWD/results:/results \
          -v $PWD/config:/config \
          justb4/jmeter:5.5 \
          jmeter -n -t /test-plans/api-performance.jmx \
            -p /config/test.properties \
            -l /results/results.jtl \
            -e -o /results/html-report \
            -Jthreads=50 \
            -Jrampup=120 \
            -Jduration=300
            
    - name: Check thresholds
      run: |
        docker run --rm \
          -v $PWD/results:/results \
          -v $PWD/config:/config \
          justb4/jmeter:5.5 \
          /bin/sh -c "/config/check-thresholds.sh /results/results.jtl"
          
    - name: Upload reports
      uses: actions/upload-artifact@v4
      with:
        name: performance-reports
        path: results/