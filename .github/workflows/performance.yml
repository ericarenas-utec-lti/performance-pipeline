name: Automated Performance Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  performance:
    name: Performance Tests with JMeter
    runs-on: windows-latest  # Cambiamos a Windows para PowerShell
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create directory structure
      run: |
        mkdir -p test-plans config results
        echo "ğŸ“ Project structure created"
        
    - name: Clean results directory
      run: |
        echo "ğŸ§¹ Cleaning previous results..."
        Remove-Item -Path "results" -Recurse -Force -ErrorAction SilentlyContinue
        New-Item -ItemType Directory -Path "results" -Force
        
    - name: Run JMeter performance tests with HTML report
      run: |
        echo "ğŸš€ Running JMeter performance tests..."
        
        # Ejecutar JMeter y generar reporte HTML
        docker run --rm `
          -v "$PWD/test-plans:/test-plans" `
          -v "$PWD/results:/results" `
          justb4/jmeter:5.5 `
          -n -t /test-plans/api-performance.jmx `
          -l /results/results.jtl `
          -e -o /results/html-report `
          -Jthreads=5 `
          -Jrampup=15 `
          -Jduration=30
          
    - name: Verify results were generated
      run: |
        echo "âœ… Checking generated files..."
        Get-ChildItem "results" -Recurse
        if (Test-Path "results/results.jtl") {
          $lineCount = (Get-Content "results/results.jtl" | Measure-Object -Line).Lines
          echo "ğŸ“ˆ Results file: $lineCount lines"
        } else {
          echo "âŒ No results file generated"
          exit 1
        }
        
    - name: Verify performance thresholds with PowerShell
      shell: pwsh
      run: |
        echo "ğŸ“Š Verifying performance thresholds with PowerShell..."
        .\config\check-thresholds.ps1 "results/results.jtl"
          
    - name: Upload HTML Report Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jmeter-html-dashboard
        path: results/html-report/
        retention-days: 30
        overwrite: true
        
    - name: Upload Test Results Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jmeter-raw-results
        path: results/
        retention-days: 30
        overwrite: true
        
    - name: Display performance summary
      shell: pwsh
      run: |
        echo "ğŸ“ˆ PERFORMANCE TEST SUMMARY"
        echo "============================"
        
        if (Test-Path "results/results.jtl") {
          $content = Get-Content "results/results.jtl"
          $totalRequests = ($content | Select-String "<httpSample").Count
          if ($totalRequests -eq 0) {
            # Intentar formato CSV
            $totalRequests = ($content | Select-String "timeStamp").Count - 1
          }
          
          $errorRequests = ($content | Select-String 's="false"').Count
          if ($errorRequests -eq 0) {
            # Intentar formato CSV
            $errorRequests = ($content | Select-String ",false,").Count
          }
          
          echo "âœ… Total Requests: $totalRequests"
          echo "âŒ Error Requests: $errorRequests"
          
          if ($totalRequests -gt 0) {
            $errorRate = [math]::Round(($errorRequests / $totalRequests) * 100, 2)
            echo "ğŸ“Š Error Rate: ${errorRate}%"
          }
        } else {
          echo "âŒ No results file generated"
        }
        
        if (Test-Path "results/html-report/index.html") {
          echo "ğŸŒ HTML Dashboard: Generated and available as artifact"
        } else {
          echo "âš ï¸ HTML Dashboard: Not generated"
        }